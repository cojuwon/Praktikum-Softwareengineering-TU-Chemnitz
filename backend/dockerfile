FROM python:3.11-slim
WORKDIR /app
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# Installation von netcat (nc) für den DB-Healthcheck
RUN apt-get update && apt-get install -y netcat-openbsd && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .

EXPOSE 8000

# Start-Logik: Warten auf DB, Migrationen anwenden, Statik sammeln, Gunicorn starten
# WICHTIG: Migrationen werden hier nur angewendet (migrate), NICHT erstellt (makemigrations).
# Migration-Dateien müssen lokal erstellt und ins Repo committed werden.
# Siehe README.md für den korrekten Workflow.
CMD sh -c "while ! nc -z db 5432; do echo 'Warte auf DB...'; sleep 1; done; \
           echo 'DB ist bereit. Wende Migrationen an...'; \
           python manage.py migrate --noinput; \
           \
           echo '--- System Setup ---'; \
           echo '1. Richte Gruppen ein...'; \
           python manage.py setup_groups; \
           echo '2. Erstelle Superuser...'; \
           python manage.py setup_superuser; \
           echo '3. Initialisiere Eingabefelder...'; \
           python scripts/init_form_fields.py; \
           echo '--------------------'; \
           \
           echo 'Sammle statische Dateien...'; \
           python manage.py collectstatic --noinput; \
           echo 'Starte Gunicorn...'; \
           exec gunicorn core.wsgi:application --bind 0.0.0.0:8000"